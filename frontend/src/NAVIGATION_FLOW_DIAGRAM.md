# 🧭 Диаграмма работы навигации

## 📱 Схема навигации приложения

```
┌─────────────────────────────────────────────────────────────────┐
│                    НАЧАЛО РАБОТЫ С ПРИЛОЖЕНИЕМ                   │
└─────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
                    ┌────────────────────────┐
                    │  customerModeSelector  │
                    │   (Выбор режима)       │
                    └────────────────────────┘
                         │              │
              Публичный  │              │  Приватный
                         │              │
                         ▼              ▼
                    ┌─────────────────────────┐
                    │        login            │
                    │    (Вход покупателя)    │
                    └─────────────────────────┘
                                 │
                                 ▼
                    ┌─────────────────────────┐
                    │         home            │
                    │    (Главная страница)   │
                    └─────────────────────────┘
                         │       │      │
           ┌─────────────┼───────┼──────┼─────────────┐
           │             │       │      │             │
           ▼             ▼       ▼      ▼             ▼
      ┌────────┐   ┌────────┐  │  ┌──────────┐  ┌─────────┐
      │ likes  │   │settings│  │  │ payment  │  │ company │
      │(Избр.) │   │(Настр.)│  │  │ (Оплата) │  │(Компания│
      └────────┘   └────────┘  │  └──────────┘  └─────────┘
           │             │      │       │             │
           └─────────────┴──────┴───────┴─────────────┘
                                 │
                                 ▼
                    🔙 Кнопка "Назад" возвращает
                       на предыдущую страницу
```

---

## 🔄 Пример навигации с кнопкой "Назад"

### Сценарий 1: Покупатель просматривает товары

```
1. Открытие приложения
   URL: #customerModeSelector
   История: [customerModeSelector]

2. Выбор публичного режима → Вход
   URL: #login
   История: [customerModeSelector, login]
   
3. Успешный вход → Главная
   URL: #home
   История: [customerModeSelector, login, home]

4. Переход в избранное
   URL: #likes
   История: [customerModeSelector, login, home, likes]

5. Нажатие кнопки "Назад" ⬅️
   URL: #home
   История: [customerModeSelector, login, home, ← likes]
   Результат: Возврат на главную страницу ✅

6. Переход в настройки
   URL: #settings
   История: [customerModeSelector, login, home, settings]

7. Нажатие кнопки "Назад" ⬅️
   URL: #home
   Результат: Возврат на главную страницу ✅
```

---

### Сценарий 2: Покупка товара

```
1. Главная страница
   URL: #home
   История: [home]

2. Добавление товаров в корзину
   URL: #home (остается)
   
3. Переход к оплате
   URL: #payment
   История: [home, payment]

4. Нажатие "Назад" ⬅️
   URL: #home
   Результат: Возврат к корзине ✅

5. Повторный переход к оплате
   URL: #payment
   История: [home, payment]

6. Успешная оплата → redirect на главную
   URL: #home
   История: [home, payment, home]
```

---

### Сценарий 3: Предотвращение выхода

```
1. Открытие приложения (первый раз)
   URL: #customerModeSelector
   История: [customerModeSelector]
   window.history.length = 1

2. Нажатие кнопки "Назад" ⬅️
   Проверка: window.history.length <= 1 → true
   Действие: event.preventDefault()
   Результат: Остаемся на странице ✅
   
   ❌ БЕЗ исправления: Выход из приложения
   ✅ С исправлением: Остаемся в приложении
```

---

## 🔧 Технические детали

### History API Events

```javascript
// Переход на новую страницу
navigateTo('likes')
  ↓
window.history.pushState({ page: 'likes' }, '', '#likes')
  ↓
URL изменяется на: example.com/#likes
  ↓
История: [..., 'home', 'likes']

// Нажатие кнопки "Назад"
Пользователь нажимает "Назад" ⬅️
  ↓
window.dispatchEvent(new PopStateEvent('popstate'))
  ↓
NavigationManager.handlePopState(event)
  ↓
Получаем state: { page: 'home' }
  ↓
Уведомляем все компоненты
  ↓
currentPage обновляется: 'likes' → 'home'
  ↓
React re-render с новой страницей
```

---

## 📊 Сравнение методов навигации

### ❌ Старый метод (useState)
```typescript
const [currentPage, setCurrentPage] = useState('home');

// Переход
setCurrentPage('settings');

// История браузера
НЕ СОЗДАЕТСЯ ❌

// Кнопка "Назад"
ВЫХОД ИЗ ПРИЛОЖЕНИЯ ❌
```

### ✅ Новый метод (History API)
```typescript
const { currentPage, navigateTo } = useNavigation();

// Переход
navigateTo('settings');

// История браузера
СОЗДАЕТСЯ ✅

// Кнопка "Назад"
ВОЗВРАТ НАЗАД ✅
```

---

## 🎯 Возможные переходы

```
customerModeSelector
  ├─→ login (публичный/приватный режим)
  └─→ companyLogin (для компаний)

login
  ├─→ home (после успешного входа)
  └─→ customerModeSelector (кнопка "Назад")

home
  ├─→ likes (избранное)
  ├─→ settings (настройки)
  ├─→ payment (оплата)
  └─→ login (выход)

likes
  ├─→ home (кнопка "Назад")
  ├─→ settings (навигация)
  └─→ payment (оплата из избранного)

settings
  ├─→ home (кнопка "Назад")
  └─→ likes (навигация)

payment
  └─→ home (после оплаты / отмена)

companyLogin
  ├─→ companyKey (после ввода логина/пароля)
  └─→ customerModeSelector (переключение на покупателя)

companyKey
  ├─→ company (после ввода ключа)
  └─→ companyLogin (кнопка "Назад")

company
  └─→ companyLogin (выход)

admin
  └─→ customerModeSelector (выход)
```

---

## 💡 Преимущества новой системы

| Функция | Описание | Статус |
|---------|----------|--------|
| **История браузера** | Правильная история всех переходов | ✅ |
| **Кнопка "Назад"** | Возврат на предыдущую страницу | ✅ |
| **URL Hash** | Визуальное отображение текущей страницы | ✅ |
| **Передача данных** | Передача данных между страницами | ✅ |
| **Программный возврат** | `goBack()` для возврата в коде | ✅ |
| **Предотвращение выхода** | Остаемся в приложении | ✅ |
| **Подписка на изменения** | `subscribe()` для реакции на навигацию | ✅ |
| **Замена без истории** | `replace()` для замены страницы | ✅ |
| **Сброс навигации** | `reset()` к начальной странице | ✅ |

---

## 🐛 Обработка edge cases

### 1. Прямой переход по URL
```
Пользователь открывает: example.com/#settings
  ↓
NavigationManager читает hash из URL
  ↓
Восстанавливает состояние: { page: 'settings' }
  ↓
Приложение открывается на странице настроек ✅
```

### 2. Обновление страницы (F5)
```
Текущая страница: #home
Пользователь нажимает F5
  ↓
Страница перезагружается
  ↓
NavigationManager читает #home из URL
  ↓
Восстанавливает: { page: 'home' }
  ↓
Пользователь остается на главной странице ✅
```

### 3. Попытка выхода на первой странице
```
История: [customerModeSelector]
Пользователь нажимает "Назад"
  ↓
window.history.length <= 1 → true
  ↓
event.preventDefault()
  ↓
Приложение НЕ закрывается ✅
```

---

## 📱 Поддержка мобильных устройств

### Android
- ✅ Физическая кнопка "Назад"
- ✅ Жест свайпа с края экрана
- ✅ Системная навигация

### iOS
- ✅ Жест свайпа с края экрана
- ✅ Кнопка "Назад" в Safari
- ✅ Системная навигация

### Desktop
- ✅ Кнопка "Назад" в браузере
- ✅ Горячие клавиши (Alt+Left, Backspace)
- ✅ Контекстное меню браузера

---

## 🎉 Итог

Новая система навигации обеспечивает:
- ✅ Правильную работу кнопки "Назад" на всех устройствах
- ✅ Сохранение истории переходов
- ✅ Предотвращение случайного выхода из приложения
- ✅ Нативный UX на мобильных устройствах
- ✅ Полная обратная совместимость

**Пользователи теперь могут свободно перемещаться по приложению и использовать привычную кнопку "Назад" без риска выйти из приложения!** 🎊
