# 🎨 ВИЗУАЛЬНАЯ СХЕМА: Исправление company_id

## 📊 ДО ИСПРАВЛЕНИЯ (❌ ПРОБЛЕМА)

```
┌─────────────────────────────────────────────────────────────────┐
│  DigitalWarehouse.tsx                                           │
│  Переименование категории                                       │
└─────────────────────────────────────────────────────────────────┘
                              ↓
                    for (product of categoryProducts)
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  await updateProduct(product.id, {                              │
│    ...product,  ← ❌ ПРОБЛЕМА: весь объект включая company_id   │
│    category: "Новое название"                                   │
│  })                                                             │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  /utils/api.tsx → updateProduct()                               │
│  {                                                              │
│    id: 3391,                                                    │
│    name: "Macbook pro",                                         │
│    company_id: null,  ← ❌ null передается дальше               │
│    category: "Новое название",                                  │
│    price: 14000000,                                             │
│    ...                                                          │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  /supabase/functions/server/index.tsx                           │
│  app.put("/products/:id")                                       │
│  {                                                              │
│    company_id: null,  ← ❌ null попадает в UPDATE запрос        │
│    category: "Новое название",                                  │
│    ...                                                          │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  PostgreSQL Database                                            │
│  UPDATE products SET                                            │
│    company_id = null,  ← ❌ ОШИБКА!                             │
│    category = 'Новое название'                                  │
│  WHERE id = 3391                                                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
                    ❌ ERROR 23502
    null value in column "company_id" violates not-null constraint
```

---

## 📊 ПОСЛЕ ИСПРАВЛЕНИЯ (✅ РЕШЕНИЕ)

```
┌─────────────────────────────────────────────────────────────────┐
│  DigitalWarehouse.tsx                                           │
│  Переименование категории                                       │
└─────────────────────────────────────────────────────────────────┘
                              ↓
                    for (product of categoryProducts)
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  await updateProduct(product.id, {                              │
│    category: "Новое название"  ✅ Только нужное поле            │
│  })                                                             │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  /utils/api.tsx → updateProduct()                               │
│  ✅ ЗАЩИТА 1: Удаление company_id                               │
│  {                                                              │
│    category: "Новое название"  ✅ company_id НЕТ                │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  /supabase/functions/server/index.tsx                           │
│  ✅ ЗАЩИТА 2: Удаление company_id                               │
│  app.put("/products/:id")                                       │
│  if (body.company_id !== undefined) {                           │
│    delete body.company_id;  ✅ Удалено перед UPDATE             │
│  }                                                              │
│  {                                                              │
│    category: "Новое название"                                   │
│  }                                                              │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  PostgreSQL Database                                            │
│  UPDATE products SET                                            │
│    category = 'Новое название'  ✅ Только category              │
│  WHERE id = 3391                                                │
└─────────────────────────────────────────────────────────────────┘
                              ↓
                        ✅ SUCCESS!
                    Товар обновлен без ошибок
```

---

## 🛡️ ДВОЙНАЯ ЗАЩИТА

```
┌──────────────────────────────────────────────────────────────────┐
│  УРОВЕНЬ 1: Клиентский код                                       │
│  /utils/api.tsx                                                  │
│                                                                  │
│  if (cleanedUpdates.company_id !== undefined) {                 │
│    console.log("⚠️ Попытка изменить company_id!");              │
│    delete cleanedUpdates.company_id;  ✅                         │
│  }                                                               │
└──────────────────────────────────────────────────────────────────┘
                              ↓
                    Если company_id прошел дальше
                              ↓
┌──────────────────────────────────────────────────────────────────┐
│  УРОВЕНЬ 2: Серверный код                                        │
│  /supabase/functions/server/index.tsx                            │
│                                                                  │
│  if (body.company_id !== undefined) {                           │
│    console.log("⚠️ Попытка изменить company_id!");              │
│    delete body.company_id;  ✅                                   │
│  }                                                               │
└──────────────────────────────────────────────────────────────────┘
                              ↓
                    ✅ company_id ГАРАНТИРОВАННО удален
                              ↓
                    ✅ UPDATE запрос безопасен
```

---

## 📈 СРАВНЕНИЕ: БЫЛО → СТАЛО

### Переименование категории

| Было | Стало |
|------|-------|
| `{ ...product, category: "Новая" }` | `{ category: "Новая" }` |
| ❌ 10+ полей передается | ✅ 1 поле передается |
| ❌ Включая company_id | ✅ Только category |
| ❌ Риск ошибки | ✅ Безопасно |

### Обновление товара в таблице

| Было | Стало |
|------|-------|
| `{ name, price, quantity, markup_percent, category, barcode, barid, company_id }` | `{ name, price, quantity, markup_percent, category, barcode, barid }` |
| ❌ company_id обрабатывался как число | ✅ company_id удаляется автоматически |
| ❌ Пустая строка → null → ошибка | ✅ company_id НЕ передается |

---

## 🔄 ПОТОК ДАННЫХ

### Создание товара (addProduct)
```
Клиент → Сервер → База данных
{                {                INSERT INTO products (
  company_id: 1    company_id: 1    company_id,  ✅ Устанавливается
  name: "..."      name: "..."      name,
  ...              ...              ...
}                }                )
```

### Обновление товара (updateProduct) 
```
Клиент → Сервер → База данных
{                {                UPDATE products SET
  category: "X"    category: "X"    category = 'X'  ✅ Только нужные поля
  name: "..."      name: "..."      name = '...'
  ❌ company_id    ✅ удален         ❌ НЕТ company_id
}                }                WHERE id = ...
```

---

## 🎯 КЛЮЧЕВЫЕ ПРИНЦИПЫ

### 1. Неизменяемость company_id
```
┌────────────────────────────────────────┐
│  Товар создается с company_id          │
│           ↓                            │
│  company_id НИКОГДА не меняется        │
│           ↓                            │
│  Товар принадлежит компании НАВСЕГДА   │
└────────────────────────────────────────┘
```

### 2. Минималистичные обновления
```
❌ Передавать весь объект:
   { ...product, category: "X" }

✅ Передавать только изменения:
   { category: "X" }
```

### 3. Многоуровневая защита
```
1️⃣ Клиент: удаляет company_id
         ↓
2️⃣ Сервер: удаляет company_id (если прошел)
         ↓
3️⃣ База данных: получает только валидные данные
```

---

## 📝 ЧЕКЛИСТ ДЛЯ РАЗРАБОТЧИКОВ

При добавлении нового функционала обновления товаров:

- [ ] ✅ Передавать ТОЛЬКО изменяемые поля
- [ ] ❌ НЕ использовать `{ ...product, field: value }`
- [ ] ✅ Использовать `{ field: value }`
- [ ] ❌ НЕ передавать `company_id` в updates
- [ ] ❌ НЕ передавать `id` в updates (это параметр)
- [ ] ❌ НЕ передавать `created_at` в updates

**Правильно:**
```typescript
await updateProduct(product.id, {
  price: newPrice,
  quantity: newQuantity
});
```

**Неправильно:**
```typescript
await updateProduct(product.id, {
  ...product,  // ❌ НЕ ДЕЛАЙТЕ ТАК!
  price: newPrice
});
```

---

**Создано:** 10 января 2026  
**Версия:** 1.0  
**Статус:** ✅ АКТУАЛЬНО
